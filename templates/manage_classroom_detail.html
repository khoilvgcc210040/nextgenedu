{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Page</title>
</head>
<style>
    .classroom-header {
        display: block;
        padding: 10px 100px 20px 100px;
        background-color: var(--accent-color);
    }

    .classroom-header h1 {
        margin: 0;
        font-size: 40px;
    }

    .classroom-settings {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .add-section-btn, .settings-btn {
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
    }

    .classroom-navigation {
        display: flex;
        justify-content: center;
        background-color: transparent;
        padding: 10px 0 20px 0;
    }

    .classroom-navigation button {
        background-color: #fff;
        border: 2px solid #fff;
        border-radius: 8px;
        padding: 10px 30px;
        cursor: pointer;
        margin: 0 5px;
        font-size: 16px;
        font-weight: 700;
        transition: background-color 0.5s ease-in-out;
    }

    .classroom-navigation .active {
        background-color: #f97316;
        color: #fff;
    }

    .classroom-content {
        display: flex;
        justify-content: space-between;
        padding: 20px 50px;
        background-color: #fff;
    }

    .members-list, .sections-list {
        flex: 3;
        margin-left: 60px;
    }

    .member-card, .section-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 15px;
        background-color: var(--accent-color);
        transition: transform 0.2s ease-in-out;
    }

    .username, .section-name {
        font-weight: bold;
        font-size: 16px;
        color: #fff;
    }

    .date-joined, .section-description {
        color: #fff;
        opacity: 0.6;
        font-size: 12px;
    }

    .member-options, .section-options {
        cursor: pointer;
        color: #fff;
    }

    .invitation-details {
        flex: 1;
        margin-left: 20px;
    }

    .invitation-link {
        margin-bottom: 30px;
    }

    .invitation-link input {
        flex: 1;
        padding: 8px;
        border: 2px solid #000;
        border-radius: 5px;
        margin-right: 10px;
        font-size: 14px;
        font-weight: 600;
        background-color: var(--accent-color);
        color: #fff;
    }

    .copy-btn {
        padding: 8px 13px;
        border: 2px solid #f97316;
        border-radius: 5px;
        cursor: pointer;
        background-color: #fff;
        font-size: 12px;
        font-weight: 600;
        color: #f97316;
        font-size: 14px;
    }

    .copy-btn:hover {
        background-color: #f97316;
        color: #fff;
    }

    .classroom-details .detail-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .detail-icon {
        margin-right: 10px;
    }

    .hidden {
        display: none;
    }

    .manage-classroom-icon img{
        margin-right: 10px;
        width: 60px;
        height: 60px;
    }

      .bi-gear{
        transition: transform 0.3s ease-in-out;
      }

      .bi-gear:hover{
        transform: translateY(-5%);
      }

      .modal .dropdown {
        position: relative;
        padding: 7px;
        width: 100%;
        border-radius: 5px;
        border: 2px solid #000;
      }

      .card-body-create-section-submission select {
        color: #000;
        border: 1px solid var(--accent-color);
        border-radius: 3px;
        padding: 5px 10px;
        outline: none;
        cursor: pointer;
      }

      .card-body-create-section-submission label {
        font-weight: 700;
        margin-bottom: 10px;
      }

      .card-body-create-section-submission input[type="text"] {
        padding: 5px;
        width: 100%;
        border-radius: 5px;
        cursor: pointer;
        background-color: #fff;
        color: #000;
        border: 2px solid var(--accent-color);
      }

      .card-body-create-section-submission input[type="text"]::placeholder {
        color: #000;
        opacity: 1;
      }

      .card-body-create-section-submission textarea {
        padding: 5px;
        width: 100%;
        border-radius: 5px;
        cursor: pointer;
        background-color: #fff;
        color: #000;
        border: 2px solid var(--accent-color);
      }

      .card-body-create-section-submission textarea::placeholder {
        color: #000;
        opacity: 1;
      }

      .card-body-create-section-submission input[type="datetime-local"] {
        padding: 5px 10px;
        width: 100%;
        border-radius: 5px;
        background-color: #fff;
        color: #000;
        border: 2px solid var(--accent-color);
      }

      .card-body-create-section-submission .submit-modal {
        background-color: var(--accent-color);
        color: #fff;
        border: 2px solid var(--accent-color);
        font-weight: 700;
      }

      .back-icon {
        position: absolute;
        top: 13%;
        left: 5%;
        font-size: 24px;
        cursor: pointer;
        color: #000;
        z-index: 1000;
        transition: transform 0.2s ease-in-out; /* Chỉnh sửa */
    }
    
    .submission-title-content {
        display: flex;
        align-items: center;
        transition: all 0.2s ease-in-out; /* Chỉnh sửa */
    }
    
    .submission-title-content:hover {
        transform: translateX(-10%); /* Chỉnh sửa giá trị dịch chuyển */
        cursor: pointer;
    }

    .btn-back {
        display: flex;
        height: 3em;
        width: 10%;
        align-items: center;
        justify-content: center;
        border-radius: 3px;
        letter-spacing: 1px;
        transition: all 0.2s linear;
        cursor: pointer;
        border: none;
        color: #fff;
        background-color: transparent;
    }

    .btn-back > svg {
        margin-right: 5px;
        margin-left: 5px;
        font-size: 20px;
        transition: all 0.4s ease-in;
    }

    .btn-back:hover > svg {
        font-size: 1.2em;
        transform: translateX(-5px);
    }

    .btn-back:hover {
        transform: translateY(-2px);
    }
    
    .dropdown-section {
        background-color: transparent !important; 
        border: 1px solid #fff; 
        outline: none; 
        z-index: 1000; 
        cursor: pointer; 
        color: #fff; 
        font-size: 20px;
    }

    .dropdown-menu {
        background-color: var(--accent-color) !important;
        border: 3px solid #f97316 !important;
        border-radius: 3px !important;
        color: #000 !important;
        box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.1);
        transform: translate3d(-120px, 40px, 0px) !important;
    }

    .dropdown-item {
        color: #fff !important;
    }

    .dropdown-item:hover {
        background-color: #f97316 !important;
        color: #fff !important;
    }

    .addBtn {
        transition: transform 0.3s ease;
        margin-bottom: 10px; 
        background-color: #F97316; 
        color: white;
        border: 2px solid #F97316;
        border-radius: 5px;
        padding: 5px 10px;
        font-size: 16px;
    }

    .addBtn:hover {
        transform: translateY(-5%);
    }
</style>
<body>
    {% include "headerMain.html" %}

    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm" style="position: fixed; bottom: 10px; left: 10px;">
            <div class="modal-content" style="border: 2px solid var(--accent-color);">
                <div class="modal-body" style="background-color: var(--accent-color); border-radius: 5px;">
                    <p id="successMessage" class="text-center m-0" style="color: #fff;"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingSpinner" class="spinner-border" role="status" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; animation: spin 1s linear infinite; color: var(--accent-color) !important;">
        <span class="visually-hidden" style="font-size: 0.8em;">Loading...</span>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>


    <!-- Modal for delete confirmation -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--accent-color);">
                    <h5 class="modal-title" id="deleteModalLabel" style="color: #fff;">Confirm Deletion</h5>
                    <button type="button" class="btn-close" style="background-color: #fff;" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this section?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for delete submission confirmation -->
    <div class="modal fade" id="deleteSubmissionModal" tabindex="-1" aria-labelledby="deleteSubmissionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--accent-color);">
                    <h5 class="modal-title" id="deleteSubmissionModalLabel" style="color: #fff;">Confirm Deletion</h5>
                    <button type="button" class="btn-close" style="background-color: #fff;" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>  
                <div class="modal-body">
                    Are you sure you want to delete this submission?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteSubmissionBtn">Delete</button>
                </div>
            </div>  
        </div>
    </div>

    <!-- Modal for delete member confirmation -->
    <div class="modal fade" id="deleteMemberModal" tabindex="-1" aria-labelledby="deleteMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--accent-color);">
                    <h5 class="modal-title" id="deleteMemberModalLabel" style="color: #fff;">Confirm Deletion</h5>
                    <button type="button" class="btn-close" style="background-color: #fff;" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this member?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteMemberBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for block member confirmation -->
    <div class="modal fade" id="blockMemberModal" tabindex="-1" aria-labelledby="blockMemberModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--accent-color);">
                    <h5 class="modal-title" id="blockMemberModalLabel" style="color: #fff;">Confirm Block</h5>
                    <button type="button" class="btn-close" style="background-color: #fff;" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                        <div class="form-check d-flex align-items-center">
                            <input class="form-check-input" style="padding: 10px; margin-right: 10px; margin-top: 0;" type="checkbox" id="reasonCheckbox">
                            <label class="form-check-label" for="reasonCheckbox">
                                Provide a reason for blocking
                            </label>
                        </div>
                        <input type="text" class="form-control mt-3" id="blockReason" placeholder="Enter reason..." style="display: none;">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmBlockMemberBtn">Block</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('reasonCheckbox').addEventListener('change', function() {
            const blockReasonInput = document.getElementById('blockReason');
            if (this.checked) {
                blockReasonInput.style.display = 'block';
            } else {
                blockReasonInput.style.display = 'none';
            }
        });
    </script>
    

    <div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content d-flex justify-content-center align-items-center bg-transparent border-0">
                <div class="card p-4" style="max-width: 500px; width: 100%; border: 5px solid var(--accent-color)">
                    <div class="card-body-create-section-submission">
                        <h5 id="modalTitle" class="card-title text-center mb-4 font-weight-bold" style="color: #fff; background-color: #f97316; padding: 10px; margin: 20px 0; border-radius: 5px 0 5px 0;"></h5>
                        <div id="error-message" class="text-danger mb-3 text-center" style="display: none;"></div>
                        <form method="POST" action="{% url 'create_section_submission' %}" id="createForm">
                            {% csrf_token %}
                            <input type="hidden" id="actionType" name="action_type">
                            <input type="hidden" name="classroom_id" value="{{ classroom.id }}">
                            <div class="mb-3">
                                <label for="open_date">Section type:</label>
                                <select class="dropdown" id="sectionType" name="section_type">
                                    <option value="new">Create a new section</option>
                                    <option value="sub">Create a subsection</option>
                                    <option value="submission">Create a submission</option>
                                </select>
                            </div>
                            <div class="mb-3" id="parentSectionContainer" style="display: none;">
                                <label for="open_date">Parent section:</label>
                                <select class="dropdown" id="parentSection" name="parent_section">
                                    <option value="">Choose a parent section</option>
                                    {% for section in sections %}
                                        {% if not section.parent_section %}
                                            <option value="{{ section.id }}">{{ section.title }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>                            
                            <div id="submissionFields" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="open_date">Open date:</label>
                                        <input type="datetime-local" class="modal-input mb-3" name="open_date" placeholder="Open date">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="close_date">Close date:</label>
                                        <input type="datetime-local" class="modal-input mb-3" name="close_date" placeholder="Close date">
                                    </div>
                                </div>
                                <label for="open_date">Submissions type:</label>
                                <select class="dropdown mb-3" name="submission_type">
                                    <option value="">Choose a submission type</option>
                                    <option value="assignment">Assignment</option>
                                    <option value="question_test">Question Test</option>
                                </select>
                            </div>
                            <label for="open_date" id="sectionNameLabel">Section name:</label>
                            <input type="text" name="title" class="modal-input mb-3" placeholder="Name of the section... (max 20 characters)" maxlength="20">
                            <label for="open_date" id="sectionDescriptionLabel">Section description:</label>
                            <textarea name="description" class="mb-4" id="sectionDescription" placeholder="Description of the section (you should describe about 50-60 words)..."></textarea>
                            <button type="submit" class="submit-modal btn btn-dark w-100 border-0" style="background-color: var(--accent-color); overflow: hidden; transition: all 0.3s ease;">
                                <span class="btn-text">Create a section</span>
                            </button>
                        </form>                    
                    </div>
                </div>                
            </div>
        </div>
    </div>

    <script>
        document.getElementById('createForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const actionType = document.getElementById('actionType').value;
            const sectionType = document.getElementById('sectionType').value;
            const title = document.querySelector('input[name="title"]').value;
            const description = document.getElementById('sectionDescription').value;
            const parentSection = document.getElementById('parentSection').value;
            const openDate = document.querySelector('input[name="open_date"]').value;
            const closeDate = document.querySelector('input[name="close_date"]').value;
            const submissionType = document.querySelector('select[name="submission_type"]').value;
            let errorMessage = '';

            if (actionType === 'section') {
                if (sectionType === 'new' && (!title || !description)) {
                    errorMessage = 'Section name and description are required.';
                } else if (sectionType === 'sub' && (!parentSection || !title || !description)) {
                    errorMessage = 'Parent section, section name, and description are required.';
                }
            } else if (actionType === 'submission') {
                const now = new Date();
                const openDateTime = new Date(openDate);
                const closeDateTime = new Date(closeDate);

                if (!title || !description || !openDate || !closeDate || !submissionType) {
                    errorMessage = 'All fields are required for submission.';
                }
                if (closeDateTime < now || openDateTime < now) {
                    errorMessage = 'Open date and close date must be current or future date.';
                }
                if (closeDateTime <= openDateTime) {
                    errorMessage = 'Close date must be after open date.';
                    document.getElementById('error-message').innerText = errorMessage;
                    document.getElementById('error-message').style.display = 'block';
                    return;
                }
                if ((closeDateTime - openDateTime) < (24 * 60 * 60 * 1000)) {
                    errorMessage = 'The time gap between open date and close date must be at least 1 day.';
                }

                document.getElementById('sectionNameLabel').innerText = 'Submission name:';
                document.getElementById('sectionDescriptionLabel').innerText = 'Submission description:';
            }

            if (errorMessage) {
                document.getElementById('error-message').innerText = errorMessage;
                document.getElementById('error-message').style.display = 'block';
            } else {
                const form = event.target;
                const formData = new FormData(form);

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                        document.getElementById('successMessage').innerText = data.message;
                        document.getElementById('loadingSpinner').style.display = 'block';
                        successModal.show();
                        setTimeout(function() {
                            document.getElementById('loadingSpinner').style.display = 'none';
                            successModal.hide();
                            location.reload(); 
                        }, 1000);
                    } else {
                        {% comment %} alert(data.message); {% endcomment %}
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    {% comment %} alert('An error occurred. Please try again.'); {% endcomment %}
                });
            }
        });

        document.querySelectorAll('#createModal, #sectionType, input[name="title"], textarea[name="description"], #parentSection, input[name="open_date"], input[name="close_date"], select[name="submission_type"]').forEach(element => {
            element.addEventListener('input', function() {
                document.getElementById('error-message').style.display = 'none';
            });
        });

        document.getElementById('createModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('error-message').style.display = 'none';
        });

        document.getElementById('createForm').addEventListener('submit', function(event) {
            const actionType = document.getElementById('actionType').value;
            localStorage.setItem('contentState', actionType === 'section' ? 'sections-content' : (actionType === 'submission' ? 'submissions-content' : 'members-content'));
        });

        document.getElementById('confirmDeleteSubmissionBtn').addEventListener('click', function(event) {
            localStorage.setItem('contentState', 'submissions-content');
        });

        document.getElementById('confirmDeleteMemberBtn').addEventListener('click', function(event) {
            localStorage.setItem('contentState', 'members-content');
        });

        document.getElementById('confirmBlockMemberBtn').addEventListener('click', function(event) {
            localStorage.setItem('contentState', 'members-content');
        });
    
        document.addEventListener('DOMContentLoaded', function() {
            const previousState = localStorage.getItem('contentState');
            if (previousState) {
                document.querySelectorAll('.classroom-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(previousState).classList.remove('hidden');
                document.querySelectorAll('.classroom-navigation button').forEach(button => button.classList.remove('active'));
                if (previousState === 'sections-content') {
                    document.getElementById('sections-btn').classList.add('active');
                } else if (previousState === 'submissions-content') {
                    document.getElementById('submissions-btn').classList.add('active');
                } else if (previousState === 'members-content') {
                    document.getElementById('members-btn').classList.add('active');
                }
                localStorage.removeItem('contentState');
            }
        });
    </script>
    <main>
        <div class="classroom-header">
            <div class="mt-4">
                <button id="back-link" class="btn-back" style="outline: none;">
                    <svg height="16" width="16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1024 1024">
                        <path d="M874.690416 495.52477c0 11.2973-9.168824 20.466124-20.466124 20.466124l-604.773963 0 188.083679 188.083679c7.992021 7.992021 7.992021 20.947078 0 28.939099-4.001127 3.990894-9.240455 5.996574-14.46955 5.996574-5.239328 0-10.478655-1.995447-14.479783-5.996574l-223.00912-223.00912c-3.837398-3.837398-5.996574-9.046027-5.996574-14.46955 0-5.433756 2.159176-10.632151 5.996574-14.46955l223.019353-223.029586c7.992021-7.992021 20.957311-7.992021 28.949332 0 7.992021 8.002254 7.992021 20.957311 0 28.949332l-188.073446 188.073446 604.753497 0C865.521592 475.058646 874.690416 484.217237 874.690416 495.52477z"></path>
                    </svg>
                    <span>Back</span>
                </button>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const backLink = document.getElementById('back-link');
                        backLink.addEventListener('click', function(event) {
                            event.preventDefault();
                            const referrer = document.referrer;
                            window.location.href = referrer;
                        });
                    });
                </script>
            </div> 
            <div class="d-flex align-items-center justify-content-around mb-3">
                <div class="d-flex align-items-center">
                    <div class="manage-classroom-icon">
                        <img src="{% static 'open.png' %}" alt="Folder Icon">
                    </div>
                    <h1 style="font-weight: 700; color: #fff">{{ classroom.name|truncatechars:30 }}</h1>
                </div>

                <div class="d-flex align-items-center">  
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" style="cursor: pointer; margin-left: 15px; transition: transform 0.3s;" fill="#fff" class="bi bi-gear" viewBox="0 0 16 16" onclick="window.location.href='{% url 'setting_classroom' classroom.id %}'" onmouseover="this.style.transform='rotate(90deg)'" onmouseout="this.style.transform='rotate(0deg)'">
                        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
                        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
                    </svg>  
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" style="cursor: pointer; margin-left: 15px; transition: transform 0.3s, translateX 0.3s;" fill="#fff" class="bi bi-arrow-up-right-square-fill" viewBox="0 0 16 16" onclick="window.location.href='{% url 'classroom_detail' classroom.id %}'" onmouseover="this.style.transform='translateY(-3%)'" onmouseout="this.style.transform='translateX(0)'">
                        <path d="M14 0a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zM5.904 10.803 10 6.707v2.768a.5.5 0 0 0 1 0V5.5a.5.5 0 0 0-.5-.5H6.525a.5.5 0 1 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 .707.707"/>
                    </svg>               
                </div>
            </div>

            <div class="classroom-navigation">
                <button id="sections-btn" class="active">Sections</button>
                <button id="submissions-btn">Submissions</button>
                <button id="members-btn">Members</button>
            </div>
            
        </div>

        

        <div id="sections-content" class="classroom-content">
            <div class="sections-list">
                <div class="d-flex justify-content-end">
                    <button id="createSectionBtn" class="addBtn" data-bs-toggle="modal" data-bs-target="#createModal" data-action="section" onclick="updateModalTitle('Create a section')">✙ Add Section</button>
                </div>
                {% for section in sections %}
                <div class="section-card">
                    <span class="section-name text-uppercase">{{ section.title }}</span>
                    {% if section.parent_section %}
                        <div class="section-description">
                            Parent Section: <strong>{{ section.parent_section.title }}</strong>
                        </div>
                    {% else %}
                        <div class="section-description">
                            <em>This is a parent section</em>
                        </div>
                    {% endif %}
                    <span class="date-joined">Date Created: {{ section.date_created|date:"d/m/Y" }}</span>
                    <div class="section-options dropdown">
                        <button class="btn btn-secondary dropdown-section" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                            •••
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <li><a class="dropdown-item" href="#" onclick="window.location.href='{% url 'classroom_detail' classroom.id %}?section_id={{ section.id }}{% if section.parent_section %}&parent_section_id={{ section.parent_section.id }}{% endif %}'">Edit section</a></li>
                            {% if not forloop.first %}
                            <li><a class="dropdown-item" href="#" onclick="deleteSection({{ section.id }})">Delete section</a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="invitation-details">
                <div class="invitation-link">
                    <label style="font-weight: 700; font-size: 18px; margin-bottom: 10px;">INVITATION LINK</label><br>
                    <input type="text" id="invitationLink" value="{{ request.scheme }}://{{ request.get_host }}{% url 'access_join_classroom' classroom.link %}" readonly>
                    <button class="copy-btn" onclick="copyInvitationLink()">Copy</button>
                    <script>
                        function copyInvitationLink() {
                            var copyText = document.getElementById("invitationLink");
                            var copyText1 = document.getElementById("invitationLink1");
                            var copyText2 = document.getElementById("invitationLink2");
                            copyText.select();
                            copyText1.select();
                            copyText2.select();
                            copyText.setSelectionRange(0, 99999);
                            copyText1.setSelectionRange(0, 99999);
                            copyText2.setSelectionRange(0, 99999);

                            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                            document.getElementById('successMessage').innerText = "Copied to clipboard!";
                            successModal.show();

                            setTimeout(function() {
                                successModal.hide();
                            }, 800);
                        }
                    </script>
                </div>
                <div class="classroom-details">
                    <label style="font-weight: 700; font-size: 18px; margin-bottom: 10px;">CLASSROOM DETAILS</label><br>
                    <div class="detail-item">
                        <span class="detail-icon">📚</span>
                        <span style="font-weight: 500;">Number of sections: {{ parent_sections }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">📕</span>
                        <span style="font-weight: 500;">Number of subsections: {{ child_sections }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">📝</span>
                        <span style="font-weight: 500;">Number of assignments: {{ assignments.count }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">❓</span>
                        <span style="font-weight: 500;">Number of question tests: {{ question_tests.count }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">👥</span>
                        <span style="font-weight: 500;">Number of participants: {{ num_participants }}</span>
                    </div>
                </div>                
            </div>
        </div>

        <div id="members-content" class="classroom-content hidden">
            <div class="members-list">
                {% for participant in participants %}
                    {% if participant.id and participant.user.role != 'teacher' %}
                        <div class="section-card">
                            <span class="username text-uppercase">{{ participant.user.username }}</span>
                            <span class="date-joined">Date Joined: {{ participant.date_joined|date:"d/m/Y" }}</span>
                            <div class="section-options dropdown">
                                <button class="btn btn-secondary dropdown-section" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                    •••
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    <li><a class="dropdown-item" href="#" onclick="deleteMember({{ participant.id }})">Delete</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="blockMember({{ participant.id }})">Delete and Block</a></li>
                                </ul>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="invitation-details">
                <div class="invitation-link">
                    <label style="font-weight: 700; font-size: 18px; margin-bottom: 10px;">INVITATION LINK</label><br>
                    <input type="text" id="invitationLink1" value="{{ request.scheme }}://{{ request.get_host }}{% url 'access_join_classroom' classroom.link %}" readonly>
                    <button class="copy-btn" onclick="copyInvitationLink()">Copy</button>
                </div>
                <div class="classroom-details">
                    <label style="font-weight: 700; font-size: 18px; margin-bottom: 10px;">CLASSROOM DETAILS</label><br>
                    <div class="detail-item">
                        <span class="detail-icon">📚</span>
                        <span style="font-weight: 500;">Number of sections: {{ parent_sections }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">📕</span>
                        <span style="font-weight: 500;">Number of subsections: {{ child_sections }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">📝</span>
                        <span style="font-weight: 500;">Number of assignments: {{ assignments.count }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">❓</span>
                        <span style="font-weight: 500;">Number of question tests: {{ question_tests.count }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">👥</span>
                        <span style="font-weight: 500;">Number of participants: {{ num_participants }}</span>
                    </div>
                </div>               
            </div>
        </div>

        <div id="submissions-content" class="classroom-content hidden">
            <div class="sections-list">
                <div class="d-flex justify-content-end">
                    <button id="createSubmissionBtn" class="addBtn" data-bs-toggle="modal" data-bs-target="#createModal" data-action="submission" onclick="updateModalTitle('Create a submission')">✙ Add Submission</button>
                </div>
                {% for section in sections %}
                    {% for submission in section.submissions.all %}
                        <div class="section-card">
                            <span class="section-name text-uppercase">{{ submission.title }} ({{ submission.get_submission_type_display }})</span>

                            <div class="section-description">

                                Parent Section: <strong>{{ submission.section.title }}</strong>

                            </div>
                            <span class="date-joined">Date Created: {{ submission.date_created|date:"d/m/Y" }}</span>

                            <div class="section-options dropdown">
                                <button class="btn btn-secondary dropdown-section" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                    •••
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    {% if submission.submission_type == 'question_test' %}
                                        <li><a class="dropdown-item" href="#" onclick="window.location.href='{% url 'question_test_marking' submission.id %}'">View scores</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="window.location.href='{% url 'question_list' submission.id %}'">Edit questions</a></li>
                                    {% elif submission.submission_type == 'assignment' %}
                                        <li><a class="dropdown-item" href="#" onclick="window.location.href='{% url 'marking' submission.id %}'">Marking</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="window.location.href='{% url 'classroom_detail' classroom.id %}?submission_id={{ submission.id }}&section_id={{ section.id }}'">Edit assignment</a></li>
                                    {% endif %}
                                    <li><a class="dropdown-item" href="#" onclick="deleteSubmission({{ submission.id }})">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    {% endfor %}
                {% endfor %}
            </div>
            <div class="invitation-details">
                <div class="invitation-link">
                    <label style="font-weight: 700; font-size: 18px; margin-bottom: 10px;">INVITATION LINK</label><br>
                    <input type="text" id="invitationLink2" value="{{ request.scheme }}://{{ request.get_host }}{% url 'access_join_classroom' classroom.link %}" readonly>
                    <button class="copy-btn" onclick="copyInvitationLink()">Copy</button>
                </div>
                <div class="classroom-details">
                    <label style="font-weight: 700; font-size: 18px; margin-bottom: 10px;">CLASSROOM DETAILS</label><br>
                    <div class="detail-item">
                        <span class="detail-icon">📚</span>
                        <span style="font-weight: 500;">Number of sections: {{ parent_sections }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">📕</span>
                        <span style="font-weight: 500;">Number of subsections: {{ child_sections }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">📝</span>
                        <span style="font-weight: 500;">Number of assignments: {{ assignments.count }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">❓</span>
                        <span style="font-weight: 500;">Number of question tests: {{ question_tests.count }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">👥</span>
                        <span style="font-weight: 500;">Number of participants: {{ num_participants }}</span>
                    </div>
                </div>               
            </div>
        </div>
    </main>

    <div id="preloader">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>

    <!-- Main JS File -->
    <script src="{% static 'assets/js/main.js' %}"></script>
</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Lấy các nút và các nội dung tương ứng
    const sectionsBtn = document.getElementById('sections-btn');
    const membersBtn = document.getElementById('members-btn');
    const submissionsBtn = document.getElementById('submissions-btn');

    const sectionsContent = document.getElementById('sections-content');
    const membersContent = document.getElementById('members-content');
    const submissionsContent = document.getElementById('submissions-content');

    // Hàm để ẩn tất cả nội dung
    function hideAllContents() {
        sectionsContent.classList.add('hidden');
        membersContent.classList.add('hidden');
        submissionsContent.classList.add('hidden');
    }

    // Hàm để xóa class 'active' từ tất cả các nút
    function removeActiveClass() {
        sectionsBtn.classList.remove('active');
        membersBtn.classList.remove('active');
        submissionsBtn.classList.remove('active');
    }

    // Gán sự kiện click cho từng nút
    sectionsBtn.addEventListener('click', function() {
        hideAllContents();
        removeActiveClass();
        sectionsContent.classList.remove('hidden');
        sectionsBtn.classList.add('active');
    });

    membersBtn.addEventListener('click', function() {
        hideAllContents();
        removeActiveClass();
        membersContent.classList.remove('hidden');
        membersBtn.classList.add('active');
    });

    submissionsBtn.addEventListener('click', function() {
        hideAllContents();
        removeActiveClass();
        submissionsContent.classList.remove('hidden');
        submissionsBtn.classList.add('active');
    });


    document.getElementById('sectionType').addEventListener('change', function() {
        var parentSectionContainer = document.getElementById('parentSectionContainer');
        var submissionFields = document.getElementById('submissionFields');

        if (this.value === 'sub') {
            parentSectionContainer.style.display = 'block';
            submissionFields.style.display = 'none';
        } else if (this.value === 'submission') {
            parentSectionContainer.style.display = 'block';
            submissionFields.style.display = 'block';
        } else {
            parentSectionContainer.style.display = 'none';
            submissionFields.style.display = 'none';
        }
    });

    function updateModalTitle(title) {
        document.getElementById('modalTitle').textContent = title;
    }

    let sectionIdToDelete = null;

    function deleteSection(sectionId) {
        sectionIdToDelete = sectionId;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    function deleteSubmission(submissionId) {
        submissionIdToDelete = submissionId;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteSubmissionModal'));
        deleteModal.show();
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (sectionIdToDelete !== null) {
            fetch(`{% url 'delete_section' 0 %}`.replace('0', sectionIdToDelete), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ section_id: sectionIdToDelete })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    document.getElementById('successMessage').innerText = data.message;
                    document.getElementById('loadingSpinner').style.display = 'block';
                    successModal.show();
                    setTimeout(function() {
                        document.getElementById('loadingSpinner').style.display = 'none';
                        successModal.hide();
                        location.reload();
                    }, 1000);
                } else {
                    alert('Failed to delete section.');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    document.getElementById('confirmDeleteSubmissionBtn').addEventListener('click', function() {
        if (submissionIdToDelete !== null) {
            fetch(`{% url 'delete_submission' 0 %}`.replace('0', submissionIdToDelete), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },  
                body: JSON.stringify({ submission_id: submissionIdToDelete })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    document.getElementById('successMessage').innerText = data.message;
                    document.getElementById('loadingSpinner').style.display = 'block';
                    successModal.show();
                    setTimeout(function() {
                        document.getElementById('loadingSpinner').style.display = 'none';
                        successModal.hide();
                        location.reload();
                    }, 1000);
                } else {
                    {% comment %} alert('Failed to delete submission.'); {% endcomment %}
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    document.getElementById('createSectionBtn').addEventListener('click', function() {

        document.getElementById('actionType').value = 'section';

        var sectionTypeElement = document.getElementById('sectionType');

        sectionTypeElement.value = 'new';

        
        var event = new Event('change');
        sectionTypeElement.dispatchEvent(event);
    });


    document.getElementById('createSubmissionBtn').addEventListener('click', function() {
        document.getElementById('actionType').value = 'submission';

        var sectionTypeElement = document.getElementById('sectionType');

        sectionTypeElement.value = 'submission';

        var event = new Event('change');

        sectionTypeElement.dispatchEvent(event);

    });

    let memberIdToDelete = null;
    let memberIdToBlock = null;

    function deleteMember(memberId) {
        memberIdToDelete = memberId;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteMemberModal'));
        deleteModal.show();
    }

    function blockMember(memberId) {
        memberIdToBlock = memberId;
        const blockModal = new bootstrap.Modal(document.getElementById('blockMemberModal'));
        blockModal.show();
    }

    document.getElementById('confirmDeleteMemberBtn').addEventListener('click', function() {
        if (memberIdToDelete !== null) {
            fetch(`{% url 'delete_member' %}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ member_id: memberIdToDelete })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    document.getElementById('successMessage').innerText = data.message;
                    document.getElementById('loadingSpinner').style.display = 'block';
                    successModal.show();
                    setTimeout(function() {
                        document.getElementById('loadingSpinner').style.display = 'none';
                        successModal.hide();
                        location.reload();
                    }, 1000);
                } else {
                    {% comment %} alert('Failed to delete member.'); {% endcomment %}
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    document.getElementById('confirmBlockMemberBtn').addEventListener('click', function() {
        if (memberIdToBlock !== null) {
            const blockReason = document.getElementById('blockReason').value;
            fetch(`{% url 'block_member' %}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ member_id: memberIdToBlock, reason: blockReason })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const successModal = new bootstrap.Modal(document.getElementById('successModal'));
                    document.getElementById('successMessage').innerText = data.message;
                    document.getElementById('loadingSpinner').style.display = 'block';
                    successModal.show();
                    setTimeout(function() {
                        document.getElementById('loadingSpinner').style.display = 'none';
                        successModal.hide();
                        location.reload();
                    }, 1000);
                } else {
                    {% comment %} alert('Failed to block member.'); {% endcomment %}
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    document.querySelectorAll('[data-action]').forEach(button => {
        button.addEventListener('click', function() {

            const action = this.getAttribute('data-action');

            const sectionTypeSelect = document.getElementById('sectionType');

            const options = sectionTypeSelect.options;


            for (let i = 0; i < options.length; i++) {
                if (action === 'section' && options[i].value === 'submission') {
                    options[i].style.display = 'none';

                } else if (action === 'submission' && (options[i].value === 'new' || options[i].value === 'sub')) {
                    options[i].style.display = 'none';

                } else {
                    options[i].style.display = 'block';
                }

            }


            sectionTypeSelect.value = action === 'section' ? 'new' : 'submission';

            sectionTypeSelect.dispatchEvent(new Event('change'));
        });
    });
</script>
