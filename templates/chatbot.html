<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Education Chatbot</title>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js"></script>

    <style>


        #chatbotContainer {


            width: 100%;

            max-width: 100%;


            background: var(--accent-color);

            padding: 20px;


            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            display: flex;

            flex-direction: column;
            height: 80vh;

        }
        #chatbotResponseContainer {

            margin-top: 20px;


            font-size: 1.1em;

            color: #333;

            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;

            background-color: #fafafa;

        }


        .chatbotMessage {
            display: flex;
            margin-bottom: 10px;


        }


        .chatbotMessage.user {


            justify-content: flex-end;


        }

        .chatbotMessage.bot {

            justify-content: flex-start;

        }
        .chatbotMessage .chatbotContent {

            max-width: 70%;


            padding: 10px;

            border-radius: 8px;


            position: relative;
        }


        .chatbotMessage.user .chatbotContent {


            background-color: #f97316;


        }
        .chatbotMessage.bot .chatbotContent {
            background-color: #475569;

        }

        .chatbotLoading {


            display: flex;


            align-items: center;

            justify-content: center;

        }

        .chatbotLoading span {


            display: inline-block;


            width: 8px;
            height: 8px;


            margin: 0 2px;


            background-color: #333;


            border-radius: 50%;


            animation: chatbotLoading 0.6s infinite alternate;

        }

        .chatbotLoading span:nth-child(2) {

            animation-delay: 0.2s;


        }
        .chatbotLoading span:nth-child(3) {
            animation-delay: 0.4s;

        }


        @keyframes chatbotLoading {


            from {

                transform: translateY(0);

            }

            to {

                transform: translateY(-10px);

            }
        }
        .chatbotInput {

            width: calc(100% - 40px);

            padding: 10px;

            font-size: 1em;

            border-radius: 4px;

            border: 1px solid #ccc;

            box-sizing: border-box;

            display: inline-block;


            outline: none;
        }


        .chatbotButton {


            padding: 10px;


            background: #f97316;


            color: white;

            border: none;


            border-radius: 50%;

            cursor: pointer;
            font-size: 1.2em;


            width: 40px;

            height: 40px;

            display: inline-block;

            vertical-align: top;

            margin-left: 10px;
            text-align: center;

            line-height: 20px;
            transition: transform 0.3s ease-in-out;


        }

        .chatbotButton:hover {

            transform: translateY(-2px);


        }



        .chatbotButton:disabled {


            background: #ccc;
            cursor: not-allowed;
        }
        .chatbotCopyIcon {
            float: right;
            cursor: pointer;

            font-size: 0.8em;

            color: #888;
        }

        .reset-chat-history {

            margin-top: 10px;
            background-color: var(--accent-color);

            padding: 20px;

            display: none;

        }

        .toggle-icon {
            transition: transform 0.3s ease-in-out;

        }
        .toggle-icon:hover {

            transform: translateY(-2px);

        }


        .toggle-icon.rotated {

            transform: rotate(180deg);

        }

        .toggle-icon.rotated:hover {

            transform: translateY(2px) rotate(180deg);

        }

    </style>

</head>
<body onload="scrollToChatbotContainer()">

    {% include 'headerMain.html' %}

    <div class="reset-chat-history" id="resetChatHistory">
        <h2 style="color: white; margin-bottom: 20px;">Reset Chat History</h2>
        <span style="color: white;">Please select the time to reset the chat history:</span>
        <div style="margin-top: 10px;" class="d-flex justify-content-between">

            <div>
                <label style="color: white; margin-right: 10px;"><input type="radio" name="reset_days" value="3" id="reset3days"> 3 days</label>
                <label style="color: white; margin-right: 10px;"><input type="radio" name="reset_days" value="7" id="reset7days"> 7 days</label>

                <label style="color: white; margin-right: 10px;"><input type="radio" name="reset_days" value="30" id="reset30days"> 30 days</label>
                <button class="btn" style="background-color: var(--accent-color); border: 2px solid white; color: white; transition: opacity 0.3s;" onmouseover="this.style.opacity=0.7;" onmouseout="this.style.opacity=1;" onclick="setResetDays()">Set</button>


            </div>
            <div>
                <button class="btn btn-danger" onclick="showDeleteModal()">Delete Chat History</button>

            </div>
        </div>

    </div>

    <div id="chatbotContainer">

        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="color: white;">Education Chatbot</h2>

            <i class="fas fa-chevron-up fa-lg toggle-icon" style="color: white; cursor: pointer;" onclick="toggleResetChatHistory(this)"></i> <!-- Thay đổi hàm gọi -->



        </div>

        <div id="chatbotResponseContainer">

            {% if chat_messages %}

                {% for chat in chat_messages %}


                    <div class="chatbotMessage user">


                        <div class="chatbotContent">


                            <p style="color: white; margin: 0;">{{ chat.message }}</p>

                        </div>


                    </div>


                    <div class="chatbotMessage bot">

                        <div class="chatbotContent">
                            <span style="font-weight: bold; color: white;">Chatbot:</span>

                            <p style="margin: 8px 0; white-space: pre-line; text-align: justify; color: white;">{{ chat.response }}</p>
                            <span class="chatbotCopyIcon" style="margin-top: 10px;" onclick="copyToClipboard(this, '{{ chat.response }}')"><i class="fa-regular fa-copy" style="color: white;"></i></span>


                        </div>


                    </div>


                {% endfor %}

            {% else %}


                <div class="chatbotMessage bot">

                    <div class="chatbotContent">

                        <span style="font-weight: bold; color: white;">Chatbot:</span>


                        <p style="margin: 8px 0; white-space: pre-line; text-align: justify; color: white;">Hello! How can I help you today?</p>

                    </div>


                </div>

            {% endif %}


        </div>

        <div style="display: flex; align-items: center; margin-top: 10px;">


            <input type="text" id="chatbotUserMessage" class="chatbotInput" placeholder="Type your question here..." oninput="toggleSendButton()">


            <button id="chatbotSendButton" class="chatbotButton" onclick="sendMessage()" disabled><i class="fa-solid fa-paper-plane"></i></button>

        </div>
    </div>

    



    <!-- Modal xác nhận xóa lịch sử -->

    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">

        <div class="modal-dialog" role="document">

            <div class="modal-content">

                <div class="modal-header" style="background-color: var(--accent-color); color: white;">
                    <h5 class="modal-title" style="color: white;">Delete Chat History</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">

                        <span aria-hidden="true" style="color: white;">&times;</span>


                    </button>
                </div>


                <div class="modal-body">


                    <p>Are you sure you want to delete the chat history?</p>

                </div>


                <div class="modal-footer">

                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>

                    <button type="button" class="btn btn-danger" onclick="deleteChatHistory()">Delete</button>

                </div>

            </div>


        </div>

    </div>


    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner-border" role="status" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; animation: spin 1s linear infinite; color: var(--accent-color) !important;">

        <span class="visually-hidden" style="font-size: 0.8em;">Loading...</span>

    </div>
    <style>
        @keyframes spin {

            0% { transform: rotate(0deg); }

            100% { transform: rotate(360deg); }
        }

    </style>


    <!-- Success Modal -->

    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">

        <div class="modal-dialog modal-sm" style="position: fixed; bottom: 10px; left: 10px;">

            <div class="modal-content" style="border: 2px solid var(--accent-color);">
                <div class="modal-body" style="background-color: var(--accent-color); border-radius: 5px;">
                    <p id="successMessage" class="text-left m-0" style="color: #fff;"></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        function toggleResetChatHistory(icon) {


            const resetChatHistory = document.getElementById("resetChatHistory");


            if (resetChatHistory.style.display === "none" || resetChatHistory.style.display === "") {


                resetChatHistory.style.display = "block";


                icon.classList.add("rotated");

                window.scrollTo({ top: 0, behavior: 'smooth' });

            } else {


                resetChatHistory.style.display = "none";

                icon.classList.remove("rotated");

            }


        }


        function getCookie(name) {
            let cookieValue = null;


            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');


                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));


                        break;
                    }
                }
            }


            return cookieValue;
        }

        function toggleSendButton() {
            const userMessage = document.getElementById("chatbotUserMessage").value;
            const sendButton = document.getElementById("chatbotSendButton");
            if (userMessage.trim()) {

                sendButton.disabled = false;


            } else {

                sendButton.disabled = true;


            }
        }



        async function sendMessage() {


            try {

                const userMessage = document.getElementById("chatbotUserMessage").value;
                if (!userMessage.trim()) {

                    alert("Please enter a question.");


                    return;

                }

                const csrftoken = getCookie('csrftoken');
                const resetDays = document.querySelector('input[name="reset_days"]:checked')?.value;

                const chatbotResponseContainer = document.getElementById("chatbotResponseContainer");




                // Append loading message


                const loadingDiv = document.createElement("div");

                loadingDiv.className = "chatbotMessage bot";

                loadingDiv.innerHTML = `<div class="chatbotContent chatbotLoading"><span></span><span></span><span></span></div>`;

                chatbotResponseContainer.appendChild(loadingDiv);

                // Scroll to bottom

                chatbotResponseContainer.scrollTop = chatbotResponseContainer.scrollHeight;


                const response = await fetch("{% url 'chatbot' %}", {
                    method: "POST",
                    headers: {

                        "Content-Type": "application/json",

                        "X-CSRFToken": csrftoken

                    },
                    body: JSON.stringify({ message: userMessage, reset_days: resetDays })

                });




                if (!response.ok) {


                    throw new Error('Network response was not ok.');


                }


                const data = await response.json();


                // Remove loading message
                chatbotResponseContainer.removeChild(loadingDiv);


                // Append user message

                const userMessageDiv = document.createElement("div");
                userMessageDiv.className = "chatbotMessage user";


                userMessageDiv.innerHTML = `<div class="chatbotContent" style="background: #f97316; color: white;">${userMessage}</div>`;

                chatbotResponseContainer.appendChild(userMessageDiv);


                // Append bot response


                const botMessageDiv = document.createElement("div");


                botMessageDiv.className = "chatbotMessage bot";
                botMessageDiv.innerHTML = `<div class="chatbotContent"><span style="font-weight: bold; color: white;">Chatbot:</span><p style="margin: 8px 0; white-space: pre-line; text-align: justify; color: white;">${data.response}</p><span class="chatbotCopyIcon" style="margin-top: 10px;" onclick="copyToClipboard(this, '${data.response}')"><i class="fa-regular fa-copy" style="color: white;"></i></span></div>`;


                chatbotResponseContainer.appendChild(botMessageDiv);



                // Clear input
                document.getElementById("chatbotUserMessage").value = "";


                toggleSendButton();


                // Scroll to bottom

                chatbotResponseContainer.scrollTop = chatbotResponseContainer.scrollHeight;



            } catch (error) {

                console.error('Error:', error);


                document.getElementById("chatbotResponseContainer").innerText = "An error occurred. Please try again.";


            }


        }



        function showDeleteModal() {

            $('#deleteModal').modal('show');
        }

        async function deleteChatHistory() {
            try {

                const csrftoken = getCookie('csrftoken');

                const response = await fetch("{% url 'chatbot' %}", {

                    method: "POST",

                    headers: {

                        "Content-Type": "application/json",
                        "X-CSRFToken": csrftoken
                    },

                    body: JSON.stringify({ delete_history: true })

                });


                if (!response.ok) {

                    throw new Error('Network response was not ok.');

                }

                const data = await response.json();
                showSuccessModal(data.response);
                setTimeout(() => location.reload(), 2000);

            } catch (error) {

                console.error('Error:', error);

                alert("An error occurred. Please try again.");


            }


        }



        function copyToClipboard(element, text) {

            navigator.clipboard.writeText(text).then(function() {

                element.innerHTML = '<i class="fa-solid fa-check"></i>';

                setTimeout(function() {

                    element.innerHTML = '<i class="fa-regular fa-copy"></i>';


                }, 5000);

            }, function(err) {


                console.error('Could not copy text: ', err);

            });


        }


        async function setResetDays() {

            try {


                const resetDays = document.querySelector('input[name="reset_days"]:checked')?.value;

                if (!resetDays) {

                    alert("Please select a reset day option.");
                    return;


                }

                const csrftoken = getCookie('csrftoken');

                const response = await fetch("{% url 'chatbot' %}", {


                    method: "POST",


                    headers: {

                        "Content-Type": "application/json",

                        "X-CSRFToken": csrftoken

                    },


                    body: JSON.stringify({ set_reset_days: true, reset_days: resetDays })

                });


                if (!response.ok) {

                    throw new Error('Network response was not ok.');

                }



                const data = await response.json();


                showSuccessModal(data.response);

            } catch (error) {

                console.error('Error:', error);
                alert("An error occurred. Please try again.");
            }


        }

        function showSuccessModal(message) {
            const successMessage = document.getElementById('successMessage');

            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            const preloader = document.getElementById('loadingSpinner');

            successMessage.innerText = message;
            preloader.style.display = 'block';
            successModal.show();
            setTimeout(function() {

                preloader.style.display = 'none';
                successModal.hide();
            }, 2000);
        }


        // Scroll to the bottom of the chat container when the page loads
        window.onload = function() {
            const chatbotResponseContainer = document.getElementById("chatbotResponseContainer");

            chatbotResponseContainer.scrollTop = chatbotResponseContainer.scrollHeight;


            // Set the radio button based on the database value
            const resetDays = "{{ reset_days }}";

            if (resetDays) {

                document.querySelector(`input[name="reset_days"][value="${resetDays}"]`).checked = true;

            }

        }

    </script>

</body>
</html>